<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GateSwap Limit Order</title>
    <link rel="icon" type="image/png" href="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0068FF',
                        secondary: '#18E5A0',
                        accent: '#FFD700',
                        dark: '#070808',
                        'light-gray': '#E5E7EB'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        display: ['Changa One', 'system-ui', 'sans-serif']
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-8px)' }
                        }
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow-glow { text-shadow: 0 0 10px rgba(0, 104, 255, 0.5); }
            .glow-border { box-shadow: 0 0 12px rgba(24, 229, 160, 0.3); }
            .bg-grid {
                background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Ccircle cx="1" cy="1" r="1" fill="%230068FF" fill-opacity="0.1"/%3E%3C/svg%3E');
                background-size: 20px 20px;
            }
            .input-field {
                @apply w-full px-4 py-3 bg-dark/80 border border-primary/30 rounded-lg text-white placeholder-light-gray/70 focus:outline-none focus:border-secondary focus:ring-2 focus:ring-secondary/30 transition-all duration-300;
            }
            .address-input {
                @apply flex-1 bg-transparent border-none text-white font-mono text-sm focus:outline-none;
            }
            .quick-token-btn {
                @apply w-full px-4 py-2 bg-secondary text-dark rounded-lg font-medium hover:bg-secondary/80 transition-all flex items-center justify-center space-x-2;
            }
            .max-btn {
                @apply absolute right-3 top-1/2 -translate-y-1/2 px-2 py-1 bg-secondary text-dark text-xs rounded hover:bg-secondary/80 transition-all;
            }
            .order-box {
                @apply bg-dark/90 p-4 rounded-lg border border-primary/20 shadow-lg flex items-center justify-between gap-4;
            }
            .order-box span {
                @apply text-sm text-light-gray;
            }
            .order-box button {
                @apply px-4 py-2 rounded-lg font-medium transition-all;
            }
            @media (max-width: 640px) {
                .order-box {
                    @apply p-3 flex-col items-start gap-2;
                }
                .order-box span {
                    @apply text-xs;
                }
                .order-box button {
                    @apply px-3 py-1 text-sm w-full;
                }
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Changa+One&display=swap" rel="stylesheet">
</head>
<body class="bg-dark text-white font-sans overflow-x-hidden">
    <header class="fixed w-full z-50 bg-dark/90 backdrop-blur-md transition-all duration-300">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer hover:text-primary transition-colors" onclick="fillGDOG()">
                <div class="w-10 h-10 rounded-full overflow-hidden">
                    <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" alt="GDOG Logo" class="w-full h-full object-cover">
                </div>
                <span class="font-display text-3xl text-primary text-shadow-glow">GateSwap Limit Order</span>
            </div>
            <button id="menuToggle" class="md:hidden text-2xl text-primary">
                <i class="fa fa-bars"></i>
            </button>
        </div>
    </header>

    <section id="limitOrder" class="min-h-screen pt-24 pb-16 bg-grid relative overflow-hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-gradient-to-b from-primary/10 to-dark pointer-events-none"></div>
        <div class="absolute top-0 left-0 w-80 h-80 bg-primary/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-0 right-0 w-80 h-80 bg-secondary/10 rounded-full blur-3xl"></div>
        <div class="container mx-auto px-4 text-center relative z-10">
            <div class="w-48 h-48 mx-auto mb-4 animate-float cursor-pointer" onclick="fillGDOG()">
                <img src="https://woofinglabs.github.io/GdogToTheMoon/images/gdog_logo.png" alt="GDOG Logo" class="w-full h-full object-cover rounded-full border-4 border-secondary/50 glow-border">
            </div>
            <button onclick="fillGDOG()" class="quick-token-btn mb-6">
                <i class="fa fa-rocket"></i>
                <span>One-Click GDOG</span>
            </button>
            <h1 class="font-display text-5xl md:text-7xl mb-6 text-primary text-shadow-glow">GateSwap Limit Order</h1>
            <p class="text-xl md:text-2xl text-light-gray max-w-3xl mx-auto mb-10">
                Create buy orders for GDOG with GT on Gate Layer.
            </p>
            <div class="bg-dark/50 p-8 rounded-xl border border-primary/30 max-w-md mx-auto">
                <div class="flex flex-col space-y-5">
                    <button id="connectWalletButton" class="w-full px-6 py-3 bg-primary text-white rounded-full font-medium hover:bg-primary/80 transition-all shadow-lg">Connect Wallet</button>
                    <p id="networkStatus" class="text-light-gray text-sm">Click to connect wallet...</p>
                    <div class="section">
                        <div class="text-left text-light-gray mb-3 font-medium">Create Buy Order</div>
                        <div class="flex items-center bg-dark/80 p-4 rounded-lg border border-primary/20">
                            <i class="fa fa-link text-accent mr-3"></i>
                            <input id="tokenAddress" type="text" placeholder="0x... Token Address (GDOG)" class="address-input" value="0xf6D9Cf57e20bA0d33372E8998A9424aa53411E04" readonly>
                            <button class="ml-3 text-light-gray hover:text-secondary transition-colors" onclick="copyAddress('tokenAddress')">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                        <div class="relative">
                            <label class="block text-left text-light-gray mb-3 font-medium">GT Amount (You Pay)</label>
                            <input id="amountGT" type="number" placeholder="0.0" class="input-field pr-12" min="0" step="any">
                            <button id="maxGTButton" class="max-btn" onclick="setMaxGT()">MAX</button>
                        </div>
                        <div class="relative">
                            <label class="block text-left text-light-gray mb-3 font-medium">GDOG Amount (You Want)</label>
                            <input id="amountGDOG" type="number" placeholder="0.0" class="input-field" min="1" step="any">
                        </div>
                        <div class="text-light-gray text-sm py-2">
                            <span>Price per GDOG: <span id="priceInfo">0 GT</span></span>
                        </div>
                        <button id="createOrderButton" class="w-full px-6 py-3 bg-primary text-white rounded-full font-medium hover:bg-primary/80 transition-all disabled:bg-dark/50 disabled:cursor-not-allowed shadow-lg" disabled>Create Buy Order</button>
                        <div class="flex justify-center gap-4 mt-4">
                            <button class="px-4 py-2 bg-secondary text-dark rounded-lg font-medium hover:bg-secondary/80 transition-all" onclick="setPercentage(25)">25%</button>
                            <button class="px-4 py-2 bg-secondary text-dark rounded-lg font-medium hover:bg-secondary/80 transition-all" onclick="setPercentage(50)">50%</button>
                            <button class="px-4 py-2 bg-secondary text-dark rounded-lg font-medium hover:bg-secondary/80 transition-all" onclick="setPercentage(75)">75%</button>
                            <button class="px-4 py-2 bg-secondary text-dark rounded-lg font-medium hover:bg-secondary/80 transition-all" onclick="setPercentage(100)">100%</button>
                        </div>
                        <p id="balanceStatus" class="text-light-gray text-sm">GT Balance: 0 | GDOG Balance: 0</p>
                        <p id="progressStatus" class="text-light-gray text-sm">Please enter GT and GDOG amounts</p>
                    </div>
                    <div class="section">
                        <div class="text-left text-light-gray mb-3 font-medium">Your Orders</div>
                        <div id="userOrders" class="order-list max-h-60 overflow-y-auto"></div>
                    </div>
                    <div class="section">
                        <div class="text-left text-light-gray mb-3 font-medium">Active Orders</div>
                        <button id="queryOrdersButton" class="w-full px-6 py-3 bg-primary text-white rounded-full font-medium hover:bg-primary/80 transition-all shadow-lg">Query Orders</button>
                        <div id="activeOrders" class="order-list flex flex-col gap-4 mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-dark/95 py-12 border-t border-primary/20">
        <div class="container mx-auto px-4 text-center">
            <p class="text-light-gray text-sm">© 2025 GDOG. All rights reserved. DYOR and invest responsibly.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        const GDOG_TOKEN = '0xf6D9Cf57e20bA0d33372E8998A9424aa53411E04';
        const LIMIT_ORDER_CONTRACT = '0x717dee9931c75DEEB3200cBbbB85f5223cd7a600';
        const chains = {
            GateLayer: {
                chainId: 10088,
                chainName: 'Gate Layer',
                rpcUrl: 'https://gatelayer-mainnet.gatenode.cc',
                blockExplorer: 'https://www.gatescan.org/gatelayer/',
                nativeCurrency: { name: 'GT', symbol: 'GT', decimals: 18 }
            }
        };
        const contractAbi = [
            {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"orderId","type":"uint256"}],"name":"OrderCancelled","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"orderId","type":"uint256"},{"indexed":true,"internalType":"address","name":"trader","type":"address"},{"indexed":false,"internalType":"uint256","name":"amountGT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amountGDOG","type":"uint256"}],"name":"OrderCreated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"orderId","type":"uint256"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"uint256","name":"amountGT","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amountGDOG","type":"uint256"}],"name":"OrderFilled","type":"event"},
            {"inputs":[{"internalType":"uint256","name":"_orderId","type":"uint256"}],"name":"cancelOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_amountGT","type":"uint256"},{"internalType":"uint256","name":"_amountGDOG","type":"uint256"}],"name":"createOrder","outputs":[{"internalType":"uint256","name":"orderId","type":"uint256"}],"stateMutability":"payable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_orderId","type":"uint256"}],"name":"fillOrder","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_orderId","type":"uint256"}],"name":"getOrder","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"trader","type":"address"},{"internalType":"uint256","name":"amountGT","type":"uint256"},{"internalType":"uint256","name":"amountGDOG","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct GDOGLimitOrder.Order","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getActiveOrderIds","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_page","type":"uint256"},{"internalType":"uint256","name":"_perPage","type":"uint256"}],"name":"getActiveOrders","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"trader","type":"address"},{"internalType":"uint256","name":"amountGT","type":"uint256"},{"internalType":"uint256","name":"amountGDOG","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct GDOGLimitOrder.Order[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"uint256","name":"_page","type":"uint256"},{"internalType":"uint256","name":"_perPage","type":"uint256"}],"name":"getUserOrders","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"trader","type":"address"},{"internalType":"uint256","name":"amountGT","type":"uint256"},{"internalType":"uint256","name":"amountGDOG","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"internalType":"struct GDOGLimitOrder.Order[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"activeOrders","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"nextOrderId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"orders","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"trader","type":"address"},{"internalType":"uint256","name":"amountGT","type":"uint256"},{"internalType":"uint256","name":"amountGDOG","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"ordersByUser","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"stateMutability":"payable","type":"receive"}
        ];
        const erc20Abi = [
            {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
            {"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"success","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"stateMutability":"view","type":"function"}
        ];
        let web3, account, limitOrderContract, tokenContract;
        let currentTokenSymbol = 'GDOG';

        function fillGDOG() {
            document.getElementById('tokenAddress').value = GDOG_TOKEN;
            document.getElementById('progressStatus').innerText = '🚀 GDOG loaded! Ready to proceed...';
            if (web3 && account) {
                initializeContracts();
                checkBalances();
            }
        }

        async function setMaxGT() {
            if (!web3 || !account) return;
            try {
                const balance = await web3.eth.getBalance(account);
                const maxAmount = Number(web3.utils.fromWei(balance, 'ether')) - 0.1;
                document.getElementById('amountGT').value = maxAmount > 0 ? maxAmount.toFixed(6) : 0;
                document.getElementById('progressStatus').innerText = `MAX: ${maxAmount.toFixed(6)} GT loaded!`;
                updatePrice();
            } catch (error) {
                document.getElementById('progressStatus').innerText = `Error: ${error.message}`;
            }
        }

        async function initializeWeb3() {
            if (!window.ethereum) {
                document.getElementById('networkStatus').innerText = 'Please install MetaMask';
                document.getElementById('progressStatus').innerText = 'No wallet detected';
                return;
            }
            try {
                web3 = new Web3(window.ethereum);
                const chainId = await web3.eth.getChainId();
                if (chainId !== 10088) await switchNetwork('GateLayer');
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                account = (await web3.eth.getAccounts())[0];
                document.getElementById('connectWalletButton').innerText = `Connected: ${account.slice(0, 6)}...${account.slice(-4)}`;
                document.getElementById('networkStatus').innerText = 'Connected to Gate Layer (ID: 10088)';
                await initializeContracts();
                await checkBalances();
            } catch (error) {
                document.getElementById('networkStatus').innerText = 'Wallet connection failed';
                document.getElementById('progressStatus').innerText = `Error: ${error.code === 4001 ? 'User rejected request' : error.message}`;
            }
        }

        async function switchNetwork(chain) {
            const chainConfig = chains[chain];
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: `0x${chainConfig.chainId.toString(16)}` }]
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: `0x${chainConfig.chainId.toString(16)}`,
                            chainName: chainConfig.chainName,
                            rpcUrls: [chainConfig.rpcUrl],
                            nativeCurrency: chainConfig.nativeCurrency,
                            blockExplorerUrls: [chainConfig.blockExplorer]
                        }]
                    });
                } else {
                    throw switchError;
                }
            }
        }

        async function initializeContracts() {
            limitOrderContract = new web3.eth.Contract(contractAbi, LIMIT_ORDER_CONTRACT);
            tokenContract = new web3.eth.Contract(erc20Abi, GDOG_TOKEN);
            currentTokenSymbol = await tokenContract.methods.symbol().call() || 'GDOG';
        }

        async function checkBalances() {
            if (!web3 || !account || !tokenContract) {
                document.getElementById('progressStatus').innerText = 'Connect wallet to view balances';
                return;
            }
            try {
                const gtBalance = await web3.eth.getBalance(account);
                const gtBalanceFormatted = Number(web3.utils.fromWei(gtBalance, 'ether')).toFixed(4);
                const tokenBalance = await tokenContract.methods.balanceOf(account).call();
                const tokenBalanceFormatted = Number(web3.utils.fromWei(tokenBalance, 'ether')).toFixed(4);
                document.getElementById('balanceStatus').innerText = `GT: ${gtBalanceFormatted} | ${currentTokenSymbol}: ${tokenBalanceFormatted}`;
                const amountGT = document.getElementById('amountGT').value.trim();
                const amountGDOG = document.getElementById('amountGDOG').value.trim();
                document.getElementById('createOrderButton').disabled = !amountGT || !amountGDOG || amountGDOG < 1;
                document.getElementById('progressStatus').innerText = 'Ready to create buy order...';
                await updateUserOrders();
            } catch (error) {
                document.getElementById('progressStatus').innerText = `Error: ${error.message}`;
            }
        }

        function updatePrice() {
            const amountGT = parseFloat(document.getElementById('amountGT').value) || 0;
            const amountGDOG = parseFloat(document.getElementById('amountGDOG').value) || 0;
            const price = amountGDOG > 0 ? (amountGT / amountGDOG).toFixed(6) : 0;
            document.getElementById('priceInfo').innerText = `${price} GT`;
            document.getElementById('createOrderButton').disabled = !amountGT || !amountGDOG || amountGDOG < 1;
        }

        async function createOrder() {
            if (!limitOrderContract || !account) {
                document.getElementById('progressStatus').innerText = 'Connect MetaMask first!';
                return;
            }
            const amountGT = document.getElementById('amountGT').value.trim();
            const amountGDOG = document.getElementById('amountGDOG').value.trim();
            if (!amountGT || !amountGDOG || amountGDOG < 1) {
                document.getElementById('progressStatus').innerText = 'Invalid input! GDOG must be at least 1.';
                return;
            }
            const amountGTWei = web3.utils.toWei(amountGT, 'ether');
            const amountGDOGWei = web3.utils.toWei(amountGDOG, 'ether');
            const button = document.getElementById('createOrderButton');
            button.disabled = true;
            button.innerHTML = 'Creating... <i class="fa fa-spinner fa-spin ml-2"></i>';
            try {
                const gtBalance = await web3.eth.getBalance(account);
                if (web3.utils.toBN(gtBalance).lt(web3.utils.toBN(amountGTWei))) {
                    throw new Error('Insufficient GT balance');
                }
                await limitOrderContract.methods.createOrder(amountGTWei, amountGDOGWei).send({ from: account, value: amountGTWei, gas: 300000 });
                document.getElementById('progressStatus').innerText = '🚀 Buy order created successfully!';
                await checkBalances();
            } catch (error) {
                document.getElementById('progressStatus').innerText = `Error: ${error.code === 4001 ? 'User rejected transaction' : error.message}`;
            } finally {
                button.disabled = false;
                button.innerHTML = 'Create Buy Order';
            }
        }

        async function fillOrder(orderId, amountGDOG) {
            if (!limitOrderContract || !account) {
                document.getElementById('progressStatus').innerText = 'Connect MetaMask first!';
                return;
            }
            const button = document.querySelector(`button[onclick="fillOrder('${orderId}', '${amountGDOG}')"]`);
            button.disabled = true;
            button.innerHTML = 'Filling... <i class="fa fa-spinner fa-spin ml-2"></i>';
            try {
                const amountGDOGWei = web3.utils.toWei(amountGDOG, 'ether');
                const tokenBalance = await tokenContract.methods.balanceOf(account).call();
                if (web3.utils.toBN(tokenBalance).lt(web3.utils.toBN(amountGDOGWei))) {
                    throw new Error('Insufficient GDOG balance');
                }
                await tokenContract.methods.approve(LIMIT_ORDER_CONTRACT, amountGDOGWei).send({ from: account, gas: 100000 });
                await limitOrderContract.methods.fillOrder(orderId).send({ from: account, gas: 300000 });
                document.getElementById('progressStatus').innerText = '🚀 Order filled successfully!';
                await checkBalances();
                await queryOrders();
            } catch (error) {
                document.getElementById('progressStatus').innerText = `Error: ${error.code === 4001 ? 'User rejected transaction' : error.message}`;
            } finally {
                button.disabled = false;
                button.innerHTML = 'Buy';
            }
        }

        async function cancelOrder(orderId) {
            if (!limitOrderContract || !account) {
                document.getElementById('progressStatus').innerText = 'Connect MetaMask first!';
                return;
            }
            const button = document.querySelector(`button[onclick="cancelOrder('${orderId}')"]`);
            button.disabled = true;
            button.innerHTML = 'Canceling... <i class="fa fa-spinner fa-spin ml-2"></i>';
            try {
                await limitOrderContract.methods.cancelOrder(orderId).send({ from: account, gas: 200000 });
                document.getElementById('progressStatus').innerText = '✅ Order cancelled successfully!';
                await checkBalances();
            } catch (error) {
                document.getElementById('progressStatus').innerText = `Error: ${error.code === 4001 ? 'User rejected transaction' : error.message}`;
            } finally {
                button.disabled = false;
                button.innerHTML = 'Cancel';
            }
        }

        async function updateUserOrders() {
            if (!limitOrderContract || !account) return;
            const userOrdersDiv = document.getElementById('userOrders');
            try {
                const userOrders = await limitOrderContract.methods.getUserOrders(account, 0, 10).call();
                userOrdersDiv.innerHTML = userOrders.length ? '' : '<p class="text-light-gray">No orders yet.</p>';
                userOrders.forEach(order => {
                    const amountGDOG = Number(web3.utils.fromWei(order.amountGDOG, 'ether')).toFixed(3);
                    const amountGT = Number(web3.utils.fromWei(order.amountGT, 'ether')).toFixed(3);
                    const price = amountGDOG > 0 ? (Number(amountGT) / Number(amountGDOG)).toFixed(6) : 0;
                    userOrdersDiv.innerHTML += `
                        <div class="order-box">
                            <div class="flex flex-col">
                                <span>ID: ${order.id}</span>
                                <span>GT: ${amountGT}</span>
                                <span>GDOG: ${amountGDOG}</span>
                                <span>Price: ${price} GT/GDOG</span>
                            </div>
                            ${order.isActive ? `<button class="bg-secondary text-dark hover:bg-secondary/80" onclick="cancelOrder('${order.id}')">Cancel</button>` : '<span class="text-light-gray">Completed</span>'}
                        </div>
                    `;
                });
            } catch (error) {
                document.getElementById('progressStatus').innerText = `Error: ${error.message}`;
            }
        }

        async function queryOrders() {
            if (!limitOrderContract || !account) {
                document.getElementById('progressStatus').innerText = 'Connect MetaMask first!';
                return;
            }
            const activeOrdersDiv = document.getElementById('activeOrders');
            try {
                const activeOrders = await limitOrderContract.methods.getActiveOrders(0, 50).call();
                const sortedOrders = activeOrders.filter(order => order.isActive).sort((a, b) => (Number(a.amountGT) / Number(a.amountGDOG)) - (Number(b.amountGT) / Number(b.amountGDOG)));
                activeOrdersDiv.innerHTML = sortedOrders.length ? '' : '<p class="text-light-gray">No active orders.</p>';
                sortedOrders.forEach(order => {
                    const amountGDOG = Number(web3.utils.fromWei(order.amountGDOG, 'ether')).toFixed(3);
                    const amountGT = Number(web3.utils.fromWei(order.amountGT, 'ether')).toFixed(3);
                    const price = amountGDOG > 0 ? (Number(amountGT) / Number(amountGDOG)).toFixed(6) : 0;
                    activeOrdersDiv.innerHTML += `
                        <div class="order-box">
                            <div class="flex flex-col">
                                <span>ID: ${order.id}</span>
                                <span>GT: ${amountGT}</span>
                                <span>GDOG: ${amountGDOG}</span>
                                <span>Price: ${price} GT/GDOG</span>
                            </div>
                            <button class="bg-primary text-white hover:bg-primary/80" onclick="fillOrder('${order.id}', '${amountGDOG}')">Buy</button>
                        </div>
                    `;
                });
            } catch (error) {
                document.getElementById('progressStatus').innerText = `Error: ${error.message}`;
            }
        }

        function setPercentage(percentage) {
            if (!web3 || !account) return;
            web3.eth.getBalance(account).then(balance => {
                const balanceFormatted = Number(web3.utils.fromWei(balance, 'ether'));
                let amount = percentage === 100 ? (balanceFormatted > 0.1 ? (balanceFormatted - 0.1).toFixed(6) : 0) : (balanceFormatted * percentage / 100).toFixed(6);
                document.getElementById('amountGT').value = amount;
                updatePrice();
            });
        }

        function copyAddress(inputId) {
            const addr = document.getElementById(inputId).value.trim();
            if (!addr) return;
            navigator.clipboard.writeText(addr).then(() => {
                document.getElementById('progressStatus').innerText = 'Token address copied!';
                setTimeout(() => checkBalances(), 1000);
            });
        }

        document.getElementById('connectWalletButton').addEventListener('click', initializeWeb3);
        document.getElementById('createOrderButton').addEventListener('click', createOrder);
        document.getElementById('queryOrdersButton').addEventListener('click', queryOrders);
        document.getElementById('amountGT').addEventListener('input', updatePrice);
        document.getElementById('amountGDOG').addEventListener('input', updatePrice);
        window.addEventListener('load', () => {
            if (!window.location.protocol.startsWith('http')) {
                document.getElementById('networkStatus').innerText = 'Run via a local server (e.g., "npx serve") to connect MetaMask.';
            } else if (!window.ethereum) {
                document.getElementById('networkStatus').innerText = 'No wallet detected. Install MetaMask.';
            }
        });
        window.ethereum?.on('chainChanged', (chainId) => {
            if (parseInt(chainId, 16) !== 10088) {
                document.getElementById('networkStatus').innerText = 'Wrong network. Reconnect to Gate Layer.';
                web3 = null; limitOrderContract = null; account = null;
                document.getElementById('connectWalletButton').innerText = 'Connect Wallet';
                document.getElementById('progressStatus').innerText = 'Please reconnect wallet';
            } else {
                initializeWeb3();
            }
        });
        window.ethereum?.on('accountsChanged', (newAccounts) => {
            if (newAccounts.length) {
                initializeWeb3();
            } else {
                document.getElementById('networkStatus').innerText = 'Wallet disconnected. Reconnect.';
                web3 = null; limitOrderContract = null; account = null;
                document.getElementById('connectWalletButton').innerText = 'Connect Wallet';
                document.getElementById('progressStatus').innerText = 'Please reconnect wallet';
            }
        });
    </script>
</body>
</html>
